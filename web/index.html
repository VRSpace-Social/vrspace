<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VRSpace Alpha</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #2e2e2e;
      color: white;
    }

    .friend-card {
      background-color: #3b3b3b;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .friend-card img {
      width: 348px;
      height: 261px;
      object-fit: cover;
    }

    .friend-card .card-body {
      padding: 10px;
    }

    .friend-card:hover {
      background-color: #4b4b4b;
    }

    .search-bar {
      margin-top: 10px;
    }

    .category-title {
      margin-top: 20px;
      margin-bottom: 10px;
    }

    .spinner-container {
      text-align: center;
      margin-top: 20px;
    }

    .dropdown-menu-notifications {
      max-height: 300px;
      overflow-y: auto;
    }

    .dropdown-item {
      color: black;
    }

    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1060;
    }

    .toast-body {
      background-color: #2e2e2e;
      color: white;
    }

    .toast {
      opacity: 1;
    }
  </style>
</head>

<body>

  <nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Logo</a>
    <form class="form-inline search-bar">
      <input id="search-input" class="form-control mr-sm-2" type="search" placeholder="Search for friends..." aria-label="Search">
    </form>
    <div class="navbar-nav">
      <div class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-bell"></i>
          <span class="badge badge-light">3</span>
        </a>
        <div class="dropdown-menu dropdown-menu-right dropdown-menu-notifications" aria-labelledby="navbarDropdown">
          <a class="dropdown-item" href="#">Friend Request from John</a>
          <a class="dropdown-item" href="#">Jane liked your post</a>
          <a class="dropdown-item" href="#">Server maintenance at 12:00 AM</a>
        </div>
      </div>
      <a class="nav-item nav-link" href="#"><i class="fas fa-user-circle"></i></a>
    </div>
  </nav>

  <div class="container mt-4">
    <div id="spinner" class="spinner-container">
      <div class="spinner-border text-light" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <div>Loading friends data, please wait...</div>
    </div>
    <div id="online-friends" style="display:none;">
      <h2 class="category-title">Friends in Worlds you can join!</h2>
      <div class="row" id="online-friends-list">
        <!-- Online friends cards will be injected here -->
      </div>
    </div>

    

    <div id="private-worlds" style="display:none;">
      <h2 class="category-title">Friends in Private Worlds</h2>
      <div class="row" id="private-friends-list">
        <!-- Private world friends cards will be injected here -->
      </div>
    </div>

    <div id="website-active" style="display:none;">
      <h2 class="category-title">Friends Active on the Website</h2>
      <div class="row" id="website-friends-list">
        <!-- Website active friends cards will be injected here -->
      </div>
    </div>
  </div>

  <a href="/test">Test</a>

  <!-- Toast container -->
  <div class="toast-container">
    <div class="toast" id="liveToast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="5000">
      <div class="toast-header">
        <img src="..." class="rounded mr-2" alt="...">
        <strong class="mr-auto">Notification</strong>
        <small>Just now</small>
        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="toast-body" id="toastBody">
        <!-- Toast text will be inserted here -->
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://kit.fontawesome.com/9071d6386d.js" crossorigin="anonymous"></script>
  <script>
    const friendsData = async () => {
      const response = await fetch('http://localhost:3000/api/getOnlineFriends');
      const data = await response.json();
      return data;
    };

    const searchFriends = async (query) => {
      const response = await fetch(`http://localhost:3000/api/searchFriends?query=${query}`);
      const data = await response.json();
      return data;
    };

    const displayFriends = (friendsData) => {
      const onlineFriendsList = $('#online-friends-list');
      const privateFriendsList = $('#private-friends-list');
      const websiteFriendsList = $('#website-friends-list');
      const onlineFriendsSection = $('#online-friends');
      const privateWorldsSection = $('#private-worlds');
      const websiteActiveSection = $('#website-active');

      if (friendsData.length > 0) {
        onlineFriendsSection.show();
        privateWorldsSection.show();
        websiteActiveSection.show();
      }

      for (let i = 0; i < friendsData.length; i++) {
        const friend = friendsData[i];

        if (friend.instanceType === 'Private Instance') {
          let friendCard = `
          <div class="col-md-4">
            <div class="card friend-card" id="friend-card">
              <img src="${friend.worldImageUrl || 'default-image.jpg'}" class="card-img-top" alt="${friend.worldName}">
              <div class="card-body">
                <h5 class="card-title">${friend.username} is playing</h5>
                <i class="fa-solid fa-earth-americas"></i> ${friend.worldName}
                <p class="card-text">
                  <small>Players: ${friend.players}/${friend.maxPlayers}</small>
                  <br>
                  <small>${friend.instanceType}</small>
                </p>
              </div>
            </div>
          </div>
        `;
          privateFriendsList.append(friendCard);
        } else if (friend.instanceType === 'Is online on VRChat Website/API') {
          let friendCard = `
          <div class="col-md-4">
            <div class="card friend-card">
              <img src="${friend.worldImageUrl || 'default-image.jpg'}" class="card-img-top" alt="${friend.worldName}">
              <div class="card-body">
                <h5 class="card-title">${friend.username} is playing</h5>
                <i class="fa-solid fa-earth-americas"></i> ${friend.worldName}
                <p class="card-text">
                  <small>Players: ${friend.players}/${friend.maxPlayers}</small>
                  <br>
                  <small>${friend.instanceType}</small>
                </p>
              </div>
            </div>
          </div>
        `;
          websiteFriendsList.append(friendCard);
        } else {
          let worldId = (friend.instanceId).split(':')[0];
          let instanceId = (friend.instanceId).split(':')[1];
          let vrcInstanceUrl = `vrchat://launch?ref=vrchat.com&id=${friend.instanceId}`;
          let friendCard = `
          <div class="col-md-4">
            <div class="card friend-card">
              <img src="${friend.worldImageUrl || 'default-image.jpg'}" class="card-img-top" alt="${friend.worldName}">
              <div class="card-body">
                <h5 class="card-title">${friend.username} is playing</h5>
                <a href="${vrcInstanceUrl}"><i class="fa-solid fa-earth-americas"></i> ${friend.worldName}</a>
                <p class="card-text">
                  <small>Players: ${friend.players}/${friend.maxPlayers}</small>
                  <br>
                  <small>${friend.instanceType}</small>
                </p>
              </div>
            </div>
          </div>
        `;
          onlineFriendsList.append(friendCard);
        }
      }
    };

    const showToast = (toastText) => {
      $('#toastBody').text(toastText);
      $('#liveToast').toast('show');
    };

    $(document).ready(function () {
      const spinner = $('#spinner');
      const onlineFriendsList = $('#online-friends-list');
      const privateFriendsList = $('#private-friends-list');
      const websiteFriendsList = $('#website-friends-list');

      friendsData().then(friendsData => {
        spinner.hide();
        displayFriends(friendsData);
      });

      $('#friend-card').on('click', function() {
        console.log('Card clicked: ' + this.id);
      });

      $('#search-input').on('change', function () {
        const query = $(this).val();
        showToast(`Searching for friends with query: ${query}`);
        if (query.length > 0) {
          searchFriends(query).then(searchResults => {
            onlineFriendsList.empty();
            privateFriendsList.empty();
            websiteFriendsList.empty();
            displayFriends(searchResults);
          });
        } else {
          onlineFriendsList.empty();
          privateFriendsList.empty();
          websiteFriendsList.empty();
          spinner.show();
          friendsData().then(friendsData => {
            displayFriends(friendsData);
            spinner.hide();
          });
        }
      });
    });
  </script>
  <script type='text/javascript' src='./vrc-wss.js'></script>

</body>

</html>
